# Документация API чат-виджета

## Webhook Endpoint
```
POST https://n8n.e-vko.kz/webhook-test/3b55dd73-10b8-40c4-9f85-8d825e800c6d
```

## Формат входящего запроса

Чат-виджет отправляет на webhook POST-запрос со следующей структурой:

```json
{
  "message": "текст сообщения пользователя",
  "language": "ru" | "kk",
  "timestamp": "2025-12-29T10:30:00.000Z"
}
```

### Поля запроса:
- `message` (string) - текст сообщения от пользователя
- `language` (string) - текущий язык интерфейса ("ru" для русского, "kk" для казахского)
- `timestamp` (string) - ISO-формат времени отправки сообщения

## Формат ответа webhook

Webhook должен вернуть JSON-ответ в одном из следующих форматов:

### Вариант 1: Простой текстовый ответ
```json
{
  "response": "Текст ответа пользователю"
}
```

### Вариант 2: Ответ с автоматическим открытием URL
```json
{
  "response": "Открываю систему...",
  "url": "https://maps.situation-centre.kz"
}
```

### Вариант 3: Ответ с системным ключом
```json
{
  "response": "Показываю паводковую ситуацию",
  "systemKey": "floods"
}
```

### Альтернативные поля ответа:
Если webhook не возвращает поле `response`, чат попытается использовать:
- `message` - альтернативное поле для текста ответа
- `text` - еще одна альтернатива

## Доступные системные ключи (systemKey)

Если webhook возвращает `systemKey`, чат автоматически откроет соответствующую систему:

| systemKey | Название системы | URL |
|-----------|------------------|-----|
| `registries` | Реестры данных | https://forms.situation-centre.kz |
| `situationCenter` | Ситуационный центр | https://situation-centre.kz |
| `floods` | Ситуация по паводкам | https://maps.situation-centre.kz |
| `forms` | Формы сбора СЦ | https://arm.situation-centre.kz |
| `rac` | Ядро РАЦ | https://forms.situation-centre.kz/regionalanalysiscenter |
| `heatMonitoring` | Мониторинг теплоисточников | https://hs.e-vko.kz/embed/heat-monitoring |
| `mediaPlanning` | Медиапланирование | https://media.situation-centre.kz/ |
| `infoPolicy` | Информационная политика | https://forms.situation-centre.kz/informationpolicy |
| `citizenPlatform` | Платформа обращений граждан | https://crm.e-vko.kz |

## Примеры использования

### Пример 1: Простой ответ
**Запрос:**
```json
{
  "message": "Что ты умеешь?",
  "language": "ru",
  "timestamp": "2025-12-29T10:30:00.000Z"
}
```

**Ответ:**
```json
{
  "response": "Я могу помочь вам найти нужную информационную систему, показать паводковую ситуацию, открыть реестры данных и многое другое."
}
```

### Пример 2: Открытие системы по URL
**Запрос:**
```json
{
  "message": "покажи паводковую ситуацию",
  "language": "ru",
  "timestamp": "2025-12-29T10:31:00.000Z"
}
```

**Ответ:**
```json
{
  "response": "Открываю карту паводковой ситуации...\n\nСистема откроется в новой вкладке через секунду.",
  "url": "https://maps.situation-centre.kz"
}
```

### Пример 3: Открытие по системному ключу
**Запрос:**
```json
{
  "message": "открой реестры данных",
  "language": "ru",
  "timestamp": "2025-12-29T10:32:00.000Z"
}
```

**Ответ:**
```json
{
  "response": "Открываю систему реестров данных...",
  "systemKey": "registries"
}
```

### Пример 4: Ответ на казахском языке
**Запрос:**
```json
{
  "message": "су тасқыны жағдайын көрсет",
  "language": "kk",
  "timestamp": "2025-12-29T10:33:00.000Z"
}
```

**Ответ:**
```json
{
  "response": "Су тасқыны картасын ашамын...\n\nЖүйе бір секундтан кейін жаңа бетте ашылады.",
  "url": "https://maps.situation-centre.kz"
}
```

## Обработка ошибок

Если webhook недоступен или возвращает ошибку, чат автоматически переключается на локальную обработку сообщений (fallback режим) со следующими возможностями:

- Распознавание приветствий
- Показ возможностей бота
- Поиск систем по ключевым словам (40+ ключевых слов на русском и казахском)
- Автоматическое открытие систем
- Вывод списка доступных систем

## Рекомендации по разработке

1. **Время ответа**: Старайтесь отвечать быстро (< 2 секунд), т.к. пользователь видит индикатор загрузки
2. **Язык ответа**: Используйте поле `language` для формирования ответа на нужном языке
3. **Форматирование**: Поддерживается многострочный текст с `\n`
4. **Открытие ссылок**: URL открываются через 1 секунду после получения ответа для лучшего UX
5. **Обработка ошибок**: Возвращайте понятные сообщения об ошибках вместо технических деталей

## Статус коды HTTP

- **200 OK** - успешная обработка запроса
- **4xx/5xx** - ошибка (чат переключится в fallback режим)

## Контакт

При возникновении вопросов или проблем с интеграцией, обращайтесь к команде разработки портала информационных систем ВКО.
